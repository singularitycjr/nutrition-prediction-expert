## Vue2连接Websocket后监听事件方法获取this失败问题

**错误写法**：

```js
websocket.onmessage = function(event) {
    console.log(this.data); // undefined
}
```

这种写法糅合了Vue2的`this.`和Vue3的`function`，无法访问到`this`指向的任何已经定义的数据和方法。

错误产生的原因是`function` 不是一个 Vue 实例的方法，而是普通的 JavaScript 函数。在 Vue2 中，`data` 属性是一个返回对象的函数，Vue 会调用这个函数来获取组件的初始状态。

**正确写法**：

```js
websocket.onmessage = (event) => {
    console.log(this.data);
}
```

使用箭头函数，`this` 将指向定义该函数时的上下文，即 Vue 组件实例。

**原理解析**：

错误的产生主要涉及到Vue2和Vue3在响应式系统上的区别，尤其是Vue2的`data`函数和`this`关键字。

在 Vue 组件的方法中，`this` 关键字指向当前的 Vue 实例，用于访问组件的属性和方法。如果在一个普通的 JavaScript 函数中使用 `this`，它不会指向 Vue 实例。例如：

```js
function someFunction() {
  console.log(this.i); // 这里 this 不是 Vue 实例，所以 this.i 会是 undefined
}
```

但是，如果在 Vue 组件的方法中使用 `this`，它将正确地指向 Vue 实例，并且可以访问到 `data()` 中定义的属性。例如：

```js
export default {
  data() {
    return {
      i: 1
    };
  },
  methods: {
    someMethod() {
      console.log(this.i); // 这里 this 指向 Vue 实例，可以正确访问到 data() 中的 i
    }
  }
}
```

如果需要在组件外部或者非组件方法中访问 `data()` 中的属性，可以使用 Vue 实例的 `$refs` 或者其他方式来访问。例如在组件的 `setup()` 函数中使用 `ref` 来创建响应式引用：

```js
import { ref } from 'vue';

export default {
  setup() {
    const i = ref(1); // 使用 ref 创建响应式引用

    function someFunction() {
      console.log(i.value); // 访问响应式引用的值
    }

    return {
      someFunction
    };
  }
}
```



## Vue滑动到底部的写法

用户进入聊天详情页面和发送一条新消息时，一般希望聊天页面滑动到最底部已展示最新的一条消息（正如QQ、微信等聊天软件），要达到这一目的可以用以下方法：

```js
// 假设待刷新区域为<div class="chat-content" ref="messageList"></div>
scrollToBottom() {
    // 使用Vue.nextTick等待DOM更新
    this.$nextTick(() => {
        const messageList = this.$refs.messageList;
        messageList.scrollTop = messageList.scrollHeight;; 
    });
},
```

`Vue.nextTick` 是用来延迟回调的执行直到下次 DOM 更新循环之后。这确保了在回调函数执行时，所有的 DOM 更新都已完成。在你提供的代码中，`scrollToBottom` 方法使用了 `Vue.nextTick` 来确保在 DOM 更新完成后再执行滚动操作。

值得注意的是，如果想要用户进入页面时滑动到最底部，需要把该函数放在`beforeUpdate`而非`mounted`中（Vue2写法），二者区别在于：

-  `mounted` 钩子在 Vue 实例挂载完成后立即被调用，尽管组件已经挂载，但如果立即操作 DOM，可能还无法获取到正确的状态，因为 DOM 更新可能还在队列中等待执行。
-  `beforeUpdate` 钩子是 Vue 更新 DOM 之前调用的钩子，此时数据已经更新，但 DOM 更新尚未开始，使用 `Vue.nextTick` 可以确保在 DOM 更新完成后执行滚动操作。


